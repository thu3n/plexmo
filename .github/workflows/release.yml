name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.2.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from package.json
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
      
      - name: Determine release version
        id: release-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ steps.package-version.outputs.version }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release notes
        id: changelog
        run: |
          VERSION="${{ steps.release-version.outputs.version }}"
          
          # Check if this is v1.0.0 - if so, use custom intro
          if [ "$VERSION" == "v1.0.0" ]; then
            cat > release_notes.md << 'EOF'
## ðŸŽ‰ Plexmo 1.0 - Initial Release

Welcome to **Plexmo** - a modern, beautiful monitoring and analytics dashboard for your Plex ecosystem!

### âœ¨ Key Features

**Multi-Server Support**
- Native support for multiple Plex servers from a single interface
- Unified library groups across servers for seamless content browsing

**Real-Time Monitoring**
- Live session monitoring with detailed playback information
- Stream quality and bandwidth tracking
- Transcoding status and CPU usage

**Advanced Analytics**
- Comprehensive watch history and user behavior tracking
- Viewing streaks and content trends
- Detailed statistics dashboards

**Automation & Integration**
- Discord notifications for stream activity
- Scheduled content synchronization
- Tautulli import for existing watch history
- Automation rules for stream management

**Security & Access**
- Plex-based authentication
- Multi-admin support
- Granular user access control

### ðŸš€ Getting Started

Check out the [README](https://github.com/thu3n/plexmo#readme) for installation instructions using Docker or manual setup.

### ðŸ’¡ Built With

- Next.js 16 Â· TypeScript Â· Tailwind CSS 4
- Prisma Â· SQLite
- âœ¨ Vibe Coded Philosophy

---

**Note:** This project is developed independently and is not affiliated with Plex Inc.
EOF
          else
            # For future releases, generate changelog from commits
            PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
            
            if [ -z "$PREVIOUS_TAG" ]; then
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
            else
              CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            fi
            
            {
              echo "## What's Changed"
              echo ""
              echo "$CHANGELOG"
              echo ""
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${VERSION}"
            } > release_notes.md
          fi
      
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.release-version.outputs.version }}
          name: Release ${{ steps.release-version.outputs.version }}
          bodyFile: release_notes.md
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
      
      - name: Release Summary
        run: |
          echo "âœ… Release ${{ steps.release-version.outputs.version }} created successfully!"
          echo "ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release-version.outputs.version }}"

# trigger ci
